name: Release Helm Chart
on:
  workflow_dispatch:

env:
  CR_INDEX_PATH: "${{ github.workspace }}/.cr-index"
  CR_PACKAGE_PATH: "${{ github.workspace }}/.cr-release-packages"
  CR_TOOL_PATH: "${{ github.workspace }}/.cr-tool"

permissions: {}

jobs:
  validate-chart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4  # v4.3.1
        with:
          version: 'v3.14.0'

      - name: Lint Helm chart
        run: |
          helm lint charts/cloudcost-exporter

      - name: Template Helm chart with default values
        run: |
          helm template cloudcost-exporter charts/cloudcost-exporter

      - name: Template Helm chart with AWS values
        run: |
          helm template cloudcost-exporter charts/cloudcost-exporter \
            -f charts/cloudcost-exporter/values.aws.yaml

  release-chart:
    needs: validate-chart
    uses: grafana/helm-charts/.github/workflows/update-helm-repo.yaml@89c8f0a901be3ab21340b7217b938e3635602aa0
    permissions:
      contents: write
      id-token: write
      packages: write
    with:
      charts_dir: charts
      cr_configfile: cr.yaml
      ct_configfile: charts/cloudcost-exporter/ct.yaml
    secrets:
      vault_repo_secret_name: github-app
